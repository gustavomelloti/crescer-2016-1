1)

CREATE PROCEDURE ATUALIZARVALORPEDIDO(VIDPEDIDO IN NUMBER)
AS

CURSOR C_PEDIDOSITENS IS
SELECT PRECOUNITARIO, QUANTIDADE
FROM PEDIDOITEM
WHERE IDPEDIDO = VIDPEDIDO;

VVALORPEDIDO NUMERIC(10,2);

BEGIN
  
  FOR REG IN C_PEDIDOSITENS LOOP
    VVALORPEDIDO := VVALORPEDIDO + (REG.PRECOUNITARIO * REG.QUANTIDADE);
  END LOOP;
  
  UPDATE PEDIDO SET VALORPEDIDO = VVALORPEDIDO WHERE IDPEDIDO = VIDPEDIDO;
END;


-- TESTE -> EXEC ATUALIZARVALORPEDIDO(10)

2)

CREATE FUNCTION RETORNARDATAULTIMOPEDIDO(PIDCLIENTE IN NUMBER)
RETURN DATE
AS
VDATA DATE;
BEGIN
  SELECT MIN(PEDIDO.DATAPEDIDO)
  INTO VDATA
  FROM PEDIDO
  WHERE PEDIDO.IDCLIENTE = PIDCLIENTE;
  
  RETURN VDATA;
END;

--TESTE -> SELECT RETORNARDATAULTIMOPEDIDO(1) FROM DUAL;

3)

CREATE FUNCTION RETORNAQTDPEDIDOSNOPERIODO(PIDPRODUTO IN NUMBER, PPERIODO IN VARCHAR)
RETURN INT
AS
VQUANTIDAVENDAPRODUTO INTEGER;
BEGIN

  SELECT SUM(PEDIDOITEM.QUANTIDADE)
  INTO VQUANTIDAVENDAPRODUTO
  FROM PEDIDOITEM
  JOIN PEDIDO ON PEDIDO.IDPEDIDO = PEDIDOITEM.IDPEDIDO
  WHERE 
      PEDIDOITEM.IDPRODUTO = PIDPRODUTO AND
      PEDIDO.DATAPEDIDO BETWEEN TO_DATE('01/'||PPERIODO, 'dd/mm/yyyy') AND
      LAST_DAY(TO_DATE('01/'||PPERIODO, 'dd/mm/yyyy'))+0.99999;
      
  RETURN VQUANTIDAVENDAPRODUTO;
END;

SELECT RETORNAQTDPEDIDOSNOPERIODO(5500,'03/2014')
FROM DUAL;
